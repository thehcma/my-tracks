#!/usr/bin/env python3
"""
Load generator for OwnTracks backend server.

Sends random location updates to test the server and populate the live activity log.
Uses 'housemeister' as the tracker ID.
"""

import json
import random
import time
from datetime import datetime
from typing import Dict
import urllib.request
import urllib.error


def generate_random_location() -> Dict:
    """Generate a random location within reasonable bounds."""
    # Random coordinates around San Francisco area (can be adjusted)
    lat = 37.7749 + random.uniform(-0.5, 0.5)  # ±0.5 degrees (~55km)
    lon = -122.4194 + random.uniform(-0.5, 0.5)
    
    return {
        "_type": "location",
        "lat": round(lat, 6),
        "lon": round(lon, 6),
        "tst": int(datetime.now().timestamp()),
        "tid": "housemeister",
        "acc": random.randint(5, 50),  # Accuracy in meters
        "alt": random.randint(0, 100),  # Altitude in meters
        "vel": random.randint(0, 30),   # Velocity in km/h
        "batt": random.randint(20, 100), # Battery percentage
        "conn": random.choice(["w", "m"])  # WiFi or mobile
    }


def send_location(url: str, location: Dict) -> bool:
    """Send location data to the server."""
    try:
        data = json.dumps(location).encode('utf-8')
        req = urllib.request.Request(
            url,
            data=data,
            headers={'Content-Type': 'application/json'}
        )
        
        with urllib.request.urlopen(req, timeout=5) as response:
            if response.status == 201:
                print(f"✓ Sent location: {location['lat']:.6f}, {location['lon']:.6f} "
                      f"(battery: {location['batt']}%)")
                return True
            else:
                print(f"✗ Unexpected status: {response.status}")
                return False
                
    except urllib.error.HTTPError as e:
        error_body = e.read().decode('utf-8') if e.fp else ""
        print(f"✗ HTTP Error: {e.code} - {e.reason}")
        if error_body:
            print(f"  Response: {error_body}")
        return False
    except urllib.error.URLError as e:
        print(f"✗ URL Error: {e.reason}")
        return False
    except Exception as e:
        print(f"✗ Error: {e}")
        return False


def main():
    """Main load generator loop."""
    # Default to localhost, but can be changed
    server_url = "http://127.0.0.1:8080/api/locations/"
    
    print("=" * 60)
    print("OwnTracks Load Generator")
    print("=" * 60)
    print(f"Server: {server_url}")
    print(f"Tracker ID: housemeister")
    print("Press Ctrl+C to stop")
    print("=" * 60)
    print()
    
    count = 0
    try:
        while True:
            location = generate_random_location()
            if send_location(server_url, location):
                count += 1
                print(f"Total sent: {count}")
            
            # Wait 2-5 seconds between updates
            delay = random.uniform(2, 5)
            time.sleep(delay)
            
    except KeyboardInterrupt:
        print()
        print("=" * 60)
        print(f"Stopped. Total locations sent: {count}")
        print("=" * 60)


if __name__ == "__main__":
    main()
