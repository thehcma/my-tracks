#!/usr/bin/env python3
"""
Installation script for OwnTracks Django Backend.

This script automates the setup process by:
1. Creating necessary directories
2. Extracting all project files from PROJECT_FILES.txt
3. Setting up the virtual environment
4. Installing dependencies
"""

# === Auto-activate virtual environment ===
import os
import sys
from pathlib import Path

def _activate_venv() -> None:
    """Find and activate the project's virtual environment."""
    script_dir = Path(__file__).resolve().parent
    venv_python = script_dir / ".venv" / "bin" / "python"
    if venv_python.exists() and sys.executable != str(venv_python):
        os.execv(str(venv_python), [str(venv_python)] + sys.argv)

_activate_venv()
# === End auto-activate ===

from pathlib import Path
from typing import Annotated

import typer

app = typer.Typer(
    help="Install OwnTracks Django Backend from PROJECT_FILES.txt",
    add_completion=False,
)


def create_file(filepath: str, content: str) -> None:
    """Create a file with the given content."""
    path = Path(filepath)
    path.parent.mkdir(parents=True, exist_ok=True)
    path.write_text(content)
    typer.echo(f"‚úì Created {filepath}")


@app.command()
def main(
    project_files: Annotated[
        Path,
        typer.Option(
            "--project-files",
            "-p",
            help="Path to PROJECT_FILES.txt",
            exists=True,
            readable=True,
        ),
    ] = Path("PROJECT_FILES.txt"),
    dry_run: Annotated[
        bool,
        typer.Option("--dry-run", help="Show what would be created without creating"),
    ] = False,
) -> None:
    """
    Install OwnTracks Django Backend from PROJECT_FILES.txt.

    Extracts embedded files and creates the project structure.
    """
    typer.echo("=" * 60)
    typer.echo("OwnTracks Django Backend - Installation Script")
    typer.echo("=" * 60)
    typer.echo()

    if not project_files.exists():
        typer.echo(f"‚ùå Error: {project_files} not found!", err=True)
        typer.echo("Please ensure you're running this script from the project root.")
        raise typer.Exit(code=1)

    typer.echo("üìÅ Creating project structure...")
    if dry_run:
        typer.echo("   [DRY RUN - no files will be created]")
    typer.echo()

    # Read PROJECT_FILES.txt and extract file contents
    content = project_files.read_text()

    # Split by file markers
    files: dict[str, str] = {}
    current_file: str | None = None
    current_content: list[str] = []

    for line in content.split("\n"):
        if line.startswith("# ===== ") and line.endswith(" ====="):
            # Save previous file
            if current_file:
                files[current_file] = "\n".join(current_content)
            # Start new file
            current_file = line.replace("# ===== ", "").replace(" =====", "").strip()
            current_content = []
        elif current_file:
            current_content.append(line)

    # Save last file
    if current_file:
        files[current_file] = "\n".join(current_content)

    # Create all files
    created_count = 0
    for filepath, file_content in files.items():
        if filepath and file_content.strip():
            if dry_run:
                typer.echo(f"  [DRY RUN] Would create: {filepath}")
            else:
                create_file(filepath, file_content.strip() + "\n")
            created_count += 1

    typer.echo()
    if dry_run:
        typer.echo(f"‚úÖ Dry run complete. Would create {created_count} files.")
    else:
        typer.echo(f"‚úÖ Project structure created successfully! ({created_count} files)")

    typer.echo()
    typer.echo("Next steps:")
    typer.echo("1. Copy .env.example to .env and configure your settings")
    typer.echo("2. Run: uv venv")
    typer.echo("3. Run: source .venv/bin/activate")
    typer.echo("4. Run: uv pip install -e .")
    typer.echo("5. Run: python manage.py migrate")
    typer.echo("6. Run: python manage.py createsuperuser")
    typer.echo("7. Run: python manage.py runserver")
    typer.echo()
    typer.echo("=" * 60)


if __name__ == "__main__":
    app()
