#!/usr/bin/env bash
#
# Tests for the my-tracks-server script
#
# This test suite validates:
# - Help message display
# - Log level validation
# - Invalid argument handling
# - Script executes without syntax errors

# Don't exit on error - we want to run all tests
set +e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR" || exit 1

SCRIPT="./my-tracks-server"
TESTS_PASSED=0
TESTS_FAILED=0

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m' # No Color

test_help_message() {
    echo -n "Test: Help message displays... "
    if $SCRIPT --help > /dev/null 2>&1; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        ((TESTS_FAILED++))
    fi
}

test_invalid_log_level() {
    echo -n "Test: Invalid log level rejected... "
    if $SCRIPT --log-level invalid 2>&1 | grep -qi "Invalid log level"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        echo "  Expected: 'Invalid log level' message"
        echo "  Got: $($SCRIPT --log-level invalid 2>&1)"
        ((TESTS_FAILED++))
    fi
}

test_invalid_argument() {
    echo -n "Test: Invalid argument rejected... "
    if $SCRIPT --invalid-flag 2>&1 | grep -qi "Unknown option"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        echo "  Expected: 'Unknown option' message"
        echo "  Got: $($SCRIPT --invalid-flag 2>&1)"
        ((TESTS_FAILED++))
    fi
}

test_valid_log_levels() {
    echo -n "Test: Valid log levels accepted... "
    local all_valid=true
    
    for level in trace debug info warning error critical; do
        # Test that the script accepts the log level without error
        # We use a timeout and kill it quickly since we don't actually want to start the server
        # 5 second timeout needed due to collectstatic step
        if ! timeout 5 $SCRIPT --log-level "$level" 2>&1 | grep -q "Log level: $(echo "$level" | tr '[:lower:]' '[:upper:]')"; then
            all_valid=false
            break
        fi
    done
    
    if [ "$all_valid" = true ]; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        ((TESTS_FAILED++))
    fi
}

test_console_flag() {
    echo -n "Test: Console flag works... "
    if timeout 5 $SCRIPT --console 2>&1 | grep -q "Logging to: console"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        ((TESTS_FAILED++))
    fi
}

test_file_logging() {
    echo -n "Test: File logging uses fixed log name... "
    if timeout 5 $SCRIPT 2>&1 | grep -q "Logging to: logs/my-tracks.log"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        ((TESTS_FAILED++))
    fi
}

test_log_rotation() {
    echo -n "Test: Log rotation works... "
    
    # Clean up any existing logs
    rm -f logs/my-tracks.log*
    
    # Create a test log file
    mkdir -p logs
    echo "test log 1" > logs/my-tracks.log
    
    # Start server briefly to trigger rotation
    # Use 8 seconds to allow for collectstatic and server startup
    timeout 8 $SCRIPT 2>&1 > /dev/null || true
    
    # Check that old log was rotated to .1
    # The new my-tracks.log may or may not exist depending on whether daphne started logging
    if [ -f "logs/my-tracks.log.1" ]; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        ((TESTS_FAILED++))
    fi
    
    # Clean up test logs
    rm -f logs/my-tracks.log*
}

test_custom_port() {
    echo -n "Test: Custom port (18080) accepted... "
    if timeout 5 $SCRIPT --port 18080 2>&1 | grep -q "Starting Django server on http://0.0.0.0:18080/"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        ((TESTS_FAILED++))
    fi
}

test_invalid_port() {
    echo -n "Test: Invalid port rejected... "
    if $SCRIPT --port 999999 2>&1 | grep -qi "Invalid port"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        echo "  Expected: 'Invalid port' message"
        echo "  Got: $($SCRIPT --port 999999 2>&1)"
        ((TESTS_FAILED++))
    fi
}

test_non_numeric_port() {
    echo -n "Test: Non-numeric port rejected... "
    if $SCRIPT --port abc 2>&1 | grep -qi "Invalid port"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        echo "  Expected: 'Invalid port' message"
        echo "  Got: $($SCRIPT --port abc 2>&1)"
        ((TESTS_FAILED++))
    fi
}

test_shellcheck_passes() {
    echo -n "Test: Script passes shellcheck... "
    
    # Check if shellcheck is installed
    if ! command -v shellcheck > /dev/null 2>&1; then
        echo ""
        echo "❌ shellcheck not found. Attempting to install..."
        
        # Try to install via brew (macOS)
        if command -v brew > /dev/null 2>&1; then
            if brew install shellcheck; then
                echo "✅ Successfully installed shellcheck via brew"
            else
                echo -e "${RED}✗ FAIL - Could not install shellcheck via brew${NC}"
                ((TESTS_FAILED++))
                return
            fi
        else
            echo -e "${RED}✗ FAIL - brew not found, cannot install shellcheck${NC}"
            echo "Please install shellcheck manually: https://www.shellcheck.net/"
            ((TESTS_FAILED++))
            return
        fi
    fi
    
    # Run shellcheck (only fail on errors and warnings, not info messages)
    if shellcheck -S error "$SCRIPT" && shellcheck -S warning "$SCRIPT"; then
        echo -e "${GREEN}✓ PASS${NC}"
        ((TESTS_PASSED++))
    else
        echo -e "${RED}✗ FAIL${NC}"
        shellcheck "$SCRIPT" || true
        ((TESTS_FAILED++))
    fi
}

# Run all tests
echo "========================================"
echo "Running my-tracks-server script tests"
echo "========================================"
echo ""

test_help_message
test_invalid_log_level
test_invalid_argument
test_valid_log_levels
test_console_flag
test_file_logging
test_log_rotation
test_custom_port
test_invalid_port
test_non_numeric_port
test_shellcheck_passes

echo ""
echo "========================================"
echo "Test Results: ${TESTS_PASSED} passed, ${TESTS_FAILED} failed"
echo "========================================"

# Exit with error code if any tests failed
if [ $TESTS_FAILED -gt 0 ]; then
    exit 1
fi

exit 0
