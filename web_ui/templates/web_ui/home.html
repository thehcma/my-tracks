{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>My Tracks - OwnTracks Backend</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—ºï¸</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="{% static 'web_ui/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'web_ui/js/main.css' %}">
</head>
<body>
    <div class="container" id="main-container">
        <div class="left-column">
            <div class="map-section">
                <div class="map-header">
                    <div class="map-controls">
                        <div class="nav-hamburger" id="nav-hamburger">
                            <button class="hamburger-btn" id="hamburger-btn" title="Menu" aria-label="Open navigation menu">â˜°</button>
                            <div class="hamburger-dropdown hidden" id="hamburger-dropdown">
                                <a href="{% url 'web_ui:profile' %}" class="hamburger-item">ğŸ‘¤ Profile</a>
                                {% if user.is_staff %}<a href="{% url 'web_ui:admin_panel' %}" class="hamburger-item">âš™ï¸ Admin Panel</a>{% endif %}
                                <a href="{% url 'web_ui:about' %}" class="hamburger-item">ğŸ“– About &amp; Setup</a>
                                <hr class="hamburger-divider">
                                <form method="post" action="{% url 'web_ui:logout' %}" class="hamburger-logout-form">
                                    {% csrf_token %}
                                    <button type="submit" class="hamburger-item hamburger-logout">ğŸšª Logout</button>
                                </form>
                            </div>
                        </div>
                        <div class="mode-toggle" title="Switch between live updates and historic trail view">
                            <button id="live-mode-btn" class="active">ğŸ“¡ Live</button>
                            <button id="historic-mode-btn">ğŸ“… Historic</button>
                        </div>
                        <select class="time-range-selector hidden" id="time-range-selector" title="Select time range for historic trail">
                            <option value="1">Last 1 hour</option>
                            <option value="2" selected>Last 2 hours</option>
                            <option value="6">Last 6 hours</option>
                            <option value="12">Last 12 hours</option>
                            <option value="24">Last 24 hours</option>
                        </select>
                        <div class="historic-controls hidden" id="historic-controls">
                            <input type="date" id="historic-date" class="historic-date-input" title="Select date for historic trail" aria-label="Select date for historic trail">
                            <div class="time-slider-container" id="time-slider-container" title="Drag handles to set time window for historic trail">
                                <div class="time-slider-track-row">
                                    <div id="time-slider" class="time-slider"></div>
                                </div>
                                <span class="time-slider-label" id="time-slider-label">00:00 â€“ 23:59</span>
                            </div>
                        </div>
                        <div class="precision-slider-container hidden" id="precision-slider-container" title="Trail precision: 0% = Coarse (~10 pts/hr), 100% = Precise (all points)">
                            <div class="precision-slider-row">
                                <span class="precision-label">ğŸ”</span>
                                <input type="range" id="precision-slider" class="precision-slider" min="0" max="100" value="100">
                                <span class="precision-label">ğŸ¯</span>
                            </div>
                            <span class="precision-value" id="precision-value">100%</span>
                        </div>
                        <select class="device-selector" id="device-selector" title="Filter by device">
                            <option value="">All Devices</option>
                        </select>
                        <div class="status-indicator" id="server-status-indicator" title="WebSocket connection status">
                            <span class="status-dot" id="status-dot"></span>
                            <span id="status-text">Checking...</span>
                        </div>
                        <button class="header-toggle" id="theme-toggle" title="Toggle light/dark theme" aria-label="Toggle theme">ğŸŒ™</button>
                        <div class="user-menu">
                            {% if user.is_staff %}<span class="admin-badge" title="Administrator">admin</span>{% endif %}
                            <span class="user-name" title="Logged in as {{ user.username }}">{{ user.username }}</span>
                        </div>
                    </div>
                    <h2 id="map-title">ğŸ—ºï¸ Live Map</h2>
                </div>
                <div class="map-container">
                    <div id="map"></div>
                    <div id="device-legend" class="device-legend hidden"></div>
                </div>
            </div>
            <div class="resize-handle" id="resize-handle" title="Drag to resize"></div>
            <div class="activity-section">
                <div class="log-header">
                    <h2 id="activity-title">ğŸ“ Live Activity</h2>
                    <div class="log-controls">
                        <span class="log-count" id="log-count">0 events</span>
                        <button class="load-history-button" id="load-history-button" title="Load last 30 minutes of data">ğŸ“¥ Last 30min</button>
                        <button class="request-location-button" id="request-location-button" title="Request all MQTT devices to report their current location">ğŸ“ Poll Devices</button>
                        <button class="reset-button" id="reset-button" title="Clear all events and start fresh">ğŸ—‘ï¸ Reset</button>
                    </div>
                </div>
                <div id="log-container">
                    <p id="loading">Waiting for location updates...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.MY_TRACKS_CONFIG = {
            hostname: "{{ hostname }}",
            localIp: "{{ local_ip }}",
            collapsePrecision: {{ collapse_precision }}
        };

        const hamburgerBtn = document.getElementById('hamburger-btn');
        const hamburgerDropdown = document.getElementById('hamburger-dropdown');
        if (hamburgerBtn && hamburgerDropdown) {
            hamburgerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                hamburgerDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', () => {
                hamburgerDropdown.classList.add('hidden');
            });
            hamburgerDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
    </script>
    <script src="{% static 'web_ui/js/main.js' %}"></script>
</body>
</html>
