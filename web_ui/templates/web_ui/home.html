{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>My Tracks - OwnTracks Backend</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="{% static 'web_ui/css/main.css' %}">
    <link rel="stylesheet" href="{% static 'web_ui/js/main.css' %}">
</head>
<body>
    <div class="container" id="main-container">
        <div class="left-column">
            <div class="map-section">
                <div class="map-header">
                    <div class="map-controls">
                        <div class="mode-toggle" title="Switch between live updates and historic trail view">
                            <button id="live-mode-btn" class="active">üì° Live</button>
                            <button id="historic-mode-btn">üìÖ Historic</button>
                        </div>
                        <select class="time-range-selector hidden" id="time-range-selector" title="Select time range for historic trail">
                            <option value="1">Last 1 hour</option>
                            <option value="2" selected>Last 2 hours</option>
                            <option value="6">Last 6 hours</option>
                            <option value="12">Last 12 hours</option>
                            <option value="24">Last 24 hours</option>
                        </select>
                        <div class="historic-controls hidden" id="historic-controls">
                            <input type="date" id="historic-date" class="historic-date-input" title="Select date for historic trail" aria-label="Select date for historic trail">
                            <div class="time-slider-container" id="time-slider-container" title="Drag handles to set time window for historic trail">
                                <div id="time-slider" class="time-slider"></div>
                                <span class="time-slider-label" id="time-slider-label">00:00 ‚Äì 23:59</span>
                            </div>
                        </div>
                        <div class="precision-slider-container hidden" id="precision-slider-container" title="Trail precision: 0% = Coarse (~10 pts/hr), 100% = Precise (all points)">
                            <span class="precision-label">üîç</span>
                            <input type="range" id="precision-slider" class="precision-slider" min="0" max="100" value="100">
                            <span class="precision-label">üéØ</span>
                            <span class="precision-value" id="precision-value">100%</span>
                        </div>
                        <select class="device-selector" id="device-selector" title="Filter by device">
                            <option value="">All Devices</option>
                        </select>
                        <div class="status-indicator" id="server-status-indicator" title="WebSocket connection status">
                            <span class="status-dot" id="status-dot"></span>
                            <span id="status-text">Checking...</span>
                        </div>
                        <button class="header-toggle" id="sidebar-toggle" title="Toggle documentation sidebar" aria-label="Toggle sidebar">‚óÄ</button>
                        <button class="header-toggle" id="theme-toggle" title="Toggle light/dark theme" aria-label="Toggle theme">üåô</button>
                    </div>
                    <h2 id="map-title">üó∫Ô∏è Live Map</h2>
                </div>
                <div class="map-container">
                    <div id="map"></div>
                    <div id="device-legend" class="device-legend hidden"></div>
                </div>
            </div>
            <div class="resize-handle" id="resize-handle" title="Drag to resize"></div>
            <div class="activity-section">
                <div class="log-header">
                    <h2 id="activity-title">üìç Live Activity</h2>
                    <div class="log-controls">
                        <span class="log-count" id="log-count">0 events</span>
                        <button class="load-history-button" id="load-history-button" title="Load last 30 minutes of data">üì• Last 30min</button>
                        <button class="reset-button" id="reset-button" title="Clear all events and start fresh">üóëÔ∏è Reset</button>
                    </div>
                </div>
                <div id="log-container">
                    <p id="loading">Waiting for location updates...</p>
                </div>
            </div>
        </div>

        <div class="right-column">
            <h1>üó∫Ô∏è My Tracks - OwnTracks Backend</h1>
            <p>A backend server for the OwnTracks Android/iOS app.</p>

            <h2>üåê HTTP Server</h2>
            <div class="endpoint" id="network-info">
                <p><strong>Status:</strong> <span style="color: var(--success-color, #4CAF50);">‚óè Enabled</span></p>
                <p><strong>Hostname:</strong> <code id="network-hostname">{{ hostname }}</code></p>
                <p><strong>Network IPs:</strong></p>
                <div id="network-ips">
                {% for ip in local_ips %}
                    <p><code>{{ ip }}</code></p>
                {% empty %}
                    <p><code>Unable to detect</code></p>
                {% endfor %}
                </div>
                <p><strong>Port:</strong> <code>{{ server_port }}</code></p>
                <p style="margin-top: 10px;">Access from other devices on your LAN:</p>
                <div id="network-urls">
                {% for ip in local_ips %}
                    <p><code>http://{{ ip }}:{{ server_port }}/</code></p>
                {% empty %}
                    <p><code>http://{{ local_ip }}:{{ server_port }}/</code></p>
                {% endfor %}
                </div>
            </div>

            <h2>üì∂ MQTT Broker</h2>
            {% if mqtt_enabled %}
            <div class="endpoint" id="mqtt-info">
                <p><strong>Status:</strong> <span style="color: var(--success-color, #4CAF50);">‚óè Enabled</span></p>
                <p><strong>Host:</strong></p>
                <div id="mqtt-hosts">
                {% for ip in local_ips %}
                    <p><code>{{ ip }}</code></p>
                {% empty %}
                    <p><code>{{ local_ip }}</code></p>
                {% endfor %}
                </div>
                <p><strong>Port:</strong> <code id="mqtt-port">{{ mqtt_port }}</code></p>
                <p style="margin-top: 10px;">MQTT is recommended for better battery life and real-time updates.</p>
                <p style="font-size: 11px; color: var(--text-muted);">Use these settings in OwnTracks app (Mode: MQTT)</p>
            </div>
            {% else %}
            <div class="endpoint" id="mqtt-info">
                <p><strong>Status:</strong> <span style="color: var(--text-muted, #888);">‚óã Disabled</span></p>
                <p style="font-size: 11px; color: var(--text-muted);">Start server with <code>--mqtt-port 1883</code> to enable</p>
            </div>
            {% endif %}

            <h2>üìç API Endpoints</h2>

            <div class="endpoint">
                <span class="method get">GET</span>
                <a href="/api/">/api/</a>
                <p>API root - Browse all available endpoints</p>
            </div>

            <div class="endpoint">
                <span class="method post">POST</span>
                <span class="method get">GET</span>
                <a href="/api/locations/">/api/locations/</a>
                <p>Submit and query location data</p>
            </div>

            <div class="endpoint">
                <span class="method get">GET</span>
                <a href="/api/devices/">/api/devices/</a>
                <p>View registered devices</p>
            </div>

            <div class="endpoint">
                <span class="method get">GET</span>
                <a href="/admin/">/admin/</a>
                <p>Admin interface (requires superuser)</p>
            </div>

            <h2>üß™ Test the API</h2>
            <p>Submit a test location:</p>
            <pre><code>curl -X POST http://{{ local_ip }}:{{ server_port }}/api/locations/ \
  -H "Content-Type: application/json" \
  -d '{"lat": 37.7749, "lon": -122.4194, "tst": 1705329600, "tid": "AB"}'</code></pre>

            <h2>üì± Configure OwnTracks App</h2>
            <p>Set up your phone to send location data to this server:</p>
            <div class="endpoint">
                <p><strong>1. Install OwnTracks</strong></p>
                <p>Download from <a href="https://play.google.com/store/apps/details?id=org.owntracks.android" target="_blank" rel="noopener noreferrer">Google Play</a> (Android) or <a href="https://apps.apple.com/app/owntracks/id692424691" target="_blank" rel="noopener noreferrer">App Store</a> (iOS)</p>
            </div>
            <div class="endpoint">
                <p><strong>2. Open Preferences</strong></p>
                <p>Tap ‚ò∞ menu ‚Üí Preferences ‚Üí Connection</p>
            </div>
            {% if mqtt_enabled %}
            <div class="endpoint">
                <p><strong>3. Choose Connection Mode</strong></p>
                <p><strong>MQTT (Recommended):</strong> Better battery life, real-time updates</p>
                <p><strong>HTTP:</strong> Simpler setup, works without persistent connection</p>
            </div>
            <div class="endpoint">
                <p><strong>4a. For MQTT Mode:</strong></p>
                <p>Mode: <code>MQTT</code></p>
                <p>Host: <code id="owntracks-mqtt-host">{{ local_ip }}</code> (use any IP shown above)</p>
                <p>Port: <code id="owntracks-mqtt-port">{{ mqtt_port }}</code></p>
                <p>TLS: <code>OFF</code></p>
                <p>Authentication: <code>ON</code> (use your Django username/password)</p>
            </div>
            <div class="endpoint">
                <p><strong>4b. For HTTP Mode:</strong></p>
                <p>Mode: <code>HTTP</code></p>
                <p>URL: <code id="owntracks-url">http://{{ local_ip }}:{{ server_port }}/api/locations/</code> (use any IP shown above)</p>
            </div>
            {% else %}
            <div class="endpoint">
                <p><strong>3. Set Mode to HTTP</strong></p>
                <p>Mode: <code>HTTP</code></p>
            </div>
            <div class="endpoint">
                <p><strong>4. Configure URL</strong></p>
                <p>Host: <code id="owntracks-url">http://{{ local_ip }}:{{ server_port }}/api/locations/</code> (use any IP shown above)</p>
                <p style="font-size: 11px; color: var(--text-muted);">Make sure your phone is on the same WiFi network</p>
            </div>
            {% endif %}
            <div class="endpoint">
                <p><strong>5. Set Device Identifier</strong></p>
                <p>Go to Identification section:</p>
                <p>‚Ä¢ <strong>Device ID:</strong> Your device name (e.g., <code>pixel8</code>)</p>
                <p>‚Ä¢ <strong>Tracker ID:</strong> 2-letter code shown on map (e.g., <code>HC</code>)</p>
            </div>
            <div class="endpoint">
                <p><strong>6. Test Connection</strong></p>
                <p>Return to map view and tap the ‚Üë upload button to send your current location. You should see it appear here!</p>
            </div>

            <h2>ÔøΩüìö Documentation</h2>
            <ul>
                <li><a href="https://github.com/the-hcma/my-tracks" target="_blank" rel="noopener noreferrer">GitHub Repository</a></li>
                <li><a href="https://github.com/owntracks/android" target="_blank" rel="noopener noreferrer">OwnTracks Android App</a></li>
                <li>See <code>API.md</code> for complete API reference</li>
                <li>See <code>README.md</code> for setup instructions</li>
            </ul>
        </div>
    </div>

    <script>
        // Configuration passed from Django to TypeScript
        window.MY_TRACKS_CONFIG = {
            hostname: "{{ hostname }}",
            localIp: "{{ local_ip }}",
            collapsePrecision: {{ collapse_precision }}
        };
    </script>
    <script src="{% static 'web_ui/js/main.js' %}"></script>
</body>
</html>
