name: Cleanup Stale Graphite Branches

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  cleanup-stale-branches:
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup all stale graphite-base branches
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ” Finding all graphite-base branches..."
        
        # Get all branches matching graphite-base/*
        BRANCHES=$(gh api repos/${{ github.repository }}/git/refs/heads/graphite-base --jq '.[].ref' 2>/dev/null || echo "")
        
        if [ -z "$BRANCHES" ]; then
          echo "â„¹ï¸ No graphite-base branches found"
          exit 0
        fi
        
        echo "Found branches:"
        echo "$BRANCHES"
        echo ""
        
        # Calculate date 30 days ago (for closed PR cleanup)
        THIRTY_DAYS_AGO=$(date -u -d '30 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-30d +%Y-%m-%dT%H:%M:%SZ)
        echo "Cutoff date for closed PRs: ${THIRTY_DAYS_AGO}"
        echo ""
        
        DELETED=0
        KEPT=0
        
        for REF in $BRANCHES; do
          # Extract PR number from refs/heads/graphite-base/123
          PR_NUMBER=$(echo "$REF" | sed 's|refs/heads/graphite-base/||')
          
          echo "Checking PR #${PR_NUMBER}..."
          
          # Get PR details
          PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER} 2>/dev/null || echo "not_found")
          
          if [ "$PR_DATA" = "not_found" ]; then
            echo "  PR #${PR_NUMBER} not found, deleting orphan branch..."
            gh api repos/${{ github.repository }}/git/${REF} -X DELETE
            echo "  âœ… Deleted orphan graphite-base/${PR_NUMBER}"
            DELETED=$((DELETED + 1))
            continue
          fi
          
          PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
          PR_MERGED=$(echo "$PR_DATA" | jq -r '.merged')
          PR_CLOSED_AT=$(echo "$PR_DATA" | jq -r '.closed_at')
          
          if [ "$PR_STATE" = "closed" ] && [ "$PR_MERGED" = "true" ]; then
            echo "  PR #${PR_NUMBER} is merged, deleting branch..."
            gh api repos/${{ github.repository }}/git/${REF} -X DELETE
            echo "  âœ… Deleted graphite-base/${PR_NUMBER}"
            DELETED=$((DELETED + 1))
          elif [ "$PR_STATE" = "closed" ] && [ "$PR_MERGED" = "false" ]; then
            # PR was closed without merge - check if older than 30 days
            if [[ "$PR_CLOSED_AT" < "$THIRTY_DAYS_AGO" ]]; then
              echo "  PR #${PR_NUMBER} was closed without merge on ${PR_CLOSED_AT} (>30 days), deleting branch..."
              gh api repos/${{ github.repository }}/git/${REF} -X DELETE
              echo "  âœ… Deleted graphite-base/${PR_NUMBER}"
              DELETED=$((DELETED + 1))
            else
              echo "  PR #${PR_NUMBER} was closed without merge on ${PR_CLOSED_AT} (<30 days), keeping branch"
              KEPT=$((KEPT + 1))
            fi
          else
            echo "  PR #${PR_NUMBER} is still open, keeping branch"
            KEPT=$((KEPT + 1))
          fi
        done
        
        echo ""
        echo "ðŸ“Š Summary: Deleted ${DELETED} branches, kept ${KEPT} branches"
